# Fault-Tolerant Virtual Machines

> https://pdos.csail.mit.edu/6.824/papers/vm-ft.pdf
>
> https://blog.csdn.net/qq_40832456/article/details/104843098
>
> https://www.cnblogs.com/brianleelxt/p/13245754.html

容错虚拟机 (fault-tolerant Virtual Machines）：包含两台虚拟机

## 1 介绍

容错服务器：

- 主/备份方法，主机器持续的将所有状态变化发送给备份机器
- state machine方法：将服务器抽象为确定性状态机 。让 **primary** 和 **backup** 按照相同的顺序执接收相同的输入请求，对于不确定的操作使用额外的协调来保证主备状态一致
  。这种方法实现复杂，但是所需带宽较小 。

## 2 基本的FT设计

<img src="../../../../learn6.824-local/images/image-20211007200801053.png" alt="image-20211007200801053" style="zoom:50%;" />

### 2.1 确定性重放的实现

复制服务器可以建模为确定性状态机的复制。

目标：

1. 捕获必要输入和非确定性（非确定性事件：虚拟中断；非确定性操作：读取处理器的时钟周期计数器），确保确定性执行备份虚拟机
2. 正确应用备份虚拟机的输入和非确定性
3. 不降低性能

VMware的确定性重放：记录每次中断发生，在回放时有效地按适当的指令进行传送。

## 3 FT的实际应用

- 3.1 启动和重新启动FT VM：VMware vSphere的VMotion功能

- 3.2 管理日志通道

- 3.4 磁盘IOs的实现问题：非阻塞、可以并行执行，因此访问相同磁盘位置的同步磁盘操作可能导致不确定性。解决：检测 IO 争用，强制在主服务器和备份服务器上以相同的方式顺序执行这样的争用磁盘操作。
- 3.5 网络IO实现问题：禁用异步网络优化

## 4. 设计方案

### 共享磁盘与非共享磁盘

共享磁盘：主 VM 故障时磁盘仍然可用

独立的磁盘：FT VMotion不仅要同步主vm和备份vm的运行状态，还要同步它们的磁盘状态。

### 备用VM上执行磁盘读

备份VM从不读取它的虚拟磁盘

## 5. 绩效评估

FT 可以限制网络带宽的占用

## 7. 结论

