# 容错虚拟机

### 1. Introduction

容错的通用方法是主备服务器机制，当主服务器挂了，就切换到备用服务器上。理想情况下，主备服务器的所有状态都应该是一致的，包括CPU、内存、IO设备等，但维持这样的一致性需要的带宽是巨大的。

取而代之的是“状态机”方法，将机器建模为具有确定状态的机器，从某一初始状态可以经过确定的变更步骤到达某一状态。但由于服务器或者服务本身会出现一些不确定的操作，所以需要少量额外的信息来保持主备服务器之间的同步。然而，在物理机上通过额外的信息实现这样的协作是困难的。

而在运行于hypervisor之上的虚拟机中就要容易的多！

### 2. 基本的FT设计

一个经典的设计方案：主备虚拟机共享虚拟磁盘，主虚拟机收到的所有输入都会通过一个logging channel传输到备用虚拟机。备用虚拟机接着执行和主虚拟机一样的操作。

#### 2.1 确定性重演（deterministic replay）的实现

确定性的输入和操作，以及非确定性带来三个问题：
1) 正确地捕捉到所有的输入和非确定性来确保备用虚拟机地确定性执行
2) 正确地应用这些输入和非确定性到备用虚拟机上
3) 尽量不影响性能

Vmware在vSphere平台上提供了这样的确定性重演。必要的信息通过日志流来记录。

#### 2.2 FT协议

在Vmware FT中，日志不是通过磁盘来传输的，而是通过logging channel。为了实现FT，logging channel中的日志需要基于严格的FT协议来传输。

Output Requirment：……

备用服务器需要在执行输出操作之前接收到全部的重演信息。

改进的Output Rule：主VM需要在生成必要的相关日志之后再执行输出操作。

